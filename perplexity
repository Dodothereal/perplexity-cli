#!/usr/bin/env python3
"""
Perplexity CLI - Query Perplexity API from terminal
Usage: perplexity "your question here" or perplexity --chat for interactive mode
"""

import argparse
import json
import os
import re
import sys
from datetime import datetime
from pathlib import Path
from textwrap import fill

# Load .env file if available
try:
    from dotenv import load_dotenv
    env_path = Path.home() / ".perplexity" / ".env"
    load_dotenv(env_path)
except ImportError:
    pass

# Default API key (your personal key)
DEFAULT_API_KEY = os.environ.get("PERPLEXITY_API_KEY")

# ANSI color codes
class Colors:
    RESET = "\033[0m"
    BOLD = "\033[1m"
    DIM = "\033[2m"
    UNDERLINE = "\033[4m"

    # Foreground colors
    BLACK = "\033[30m"
    RED = "\033[31m"
    GREEN = "\033[32m"
    YELLOW = "\033[33m"
    BLUE = "\033[34m"
    MAGENTA = "\033[35m"
    CYAN = "\033[36m"
    WHITE = "\033[37m"
    BRIGHT_BLUE = "\033[94m"
    BRIGHT_GREEN = "\033[92m"
    BRIGHT_YELLOW = "\033[93m"
    BRIGHT_MAGENTA = "\033[95m"

    # Background colors
    BG_BLACK = "\033[40m"
    BG_RED = "\033[41m"
    BG_GREEN = "\033[42m"
    BG_YELLOW = "\033[43m"
    BG_BLUE = "\033[44m"
    BG_MAGENTA = "\033[45m"
    BG_CYAN = "\033[46m"
    BG_BRIGHT_BLUE = "\033[104m"


def clear_screen():
    """Clear terminal screen"""
    os.system('clear' if os.name != 'nt' else 'cls')


def print_box(text, width=60, padding=1):
    """Print text in a styled box"""
    border = Colors.CYAN + "â•" * width + Colors.RESET
    space = " " * (width - 2)

    print(f"\n{Colors.CYAN}â•”{border[1:-1]}â•—{Colors.RESET}")

    # Top padding
    for _ in range(padding):
        print(f"{Colors.CYAN}â•‘{space}â•‘{Colors.RESET}")

    # Content
    lines = text.split('\n')
    for line in lines:
        line = line.strip()
        if line:
            text_color = Colors.BOLD + Colors.CYAN
            content = " " + line + " "
            content = content.ljust(width - 2)
            print(f"{Colors.CYAN}â•‘{text_color}{content}{Colors.CYAN}â•‘{Colors.RESET}")

    # Bottom padding
    for _ in range(padding):
        print(f"{Colors.CYAN}â•‘{space}â•‘{Colors.RESET}")

    print(f"{Colors.CYAN}â•š{border[1:-1]}â•{Colors.RESET}\n")


def print_welcome(model="sonar-pro"):
    """Print welcome screen"""
    clear_screen()
    print(f"""
{Colors.BOLD}{Colors.CYAN}
   __  __                    _
  / / / /___  ____ ___  ____/ /___ _
 / /_/ / __ \\/ __ `__ "/ __  / __ `/
/ __  / /_/ / / / / / / /_/ / /_/ /
/_/ /_/\\____/_/ /_/ /_/\\__,_/\\__,_/

{Colors.RESET}""")

    # Status bar
    print(f"{Colors.BG_BRIGHT_BLUE}{Colors.WHITE}  Model: {Colors.BOLD}{model}{Colors.RESET}", end="")

    # Calculate padding to push date to right
    date_str = f"  {datetime.now().strftime('%Y-%m-%d %I:%M %p')}  "
    total_width = 70
    current_width = len(f"  Model: {model}")
    padding = total_width - current_width - len(date_str)

    print(" " * padding + f"{date_str}{Colors.RESET}\n")

    # Help box
    help_text = f"""{Colors.GREEN}Commands:{Colors.RESET}
  {Colors.YELLOW}/help{Colors.RESET}       Show this help
  {Colors.YELLOW}/clear{Colors.RESET}      Clear conversation history
  {Colors.YELLOW}/save{Colors.RESET}       Save current conversation
  {Colors.YELLOW}/export{Colors.RESET}     Export to Markdown
  {Colors.YELLOW}/history{Colors.RESET}    List saved conversations
  {Colors.YELLOW}/load{Colors.RESET}       Load a saved conversation
  {Colors.YELLOW}/status{Colors.RESET}     Show current session info
  {Colors.YELLOW}/quit{Colors.RESET}       Exit chat mode

{Colors.DIM}Type your message and press Enter to chat.{Colors.RESET}
"""
    print(help_text)


def print_status(client, session):
    """Print current session status"""
    msgs = len(session.messages) - 1  # Minus system prompt
    print(f"\n{Colors.BOLD}{Colors.CYAN}Session Status{Colors.RESET}")
    print(f"  Model:  {Colors.YELLOW}{session.model}{Colors.RESET}")
    print(f"  Messages:   {Colors.YELLOW}{msgs}{Colors.RESET}")
    print(f"  History dir: {Colors.DIM}{session.history_dir}{Colors.RESET}")
    print()


def print_help():
    """Print help information"""
    print_box("""
Interactive Commands

/help       - Show this help
/clear      - Clear conversation history
/save       - Save current conversation
/export     - Export conversation to Markdown
/history    - List all saved conversations
/load       - Load a saved conversation
/status     - Show current session info
/quit       - Exit chat mode

Keyboard Shortcuts
Ctrl+C      - Interrupt current response
Ctrl+D      - Exit chat mode
    """)


def print_header(text):
    """Print a styled header"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'â”€' * 70}{Colors.RESET}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.RESET}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'â”€' * 70}{Colors.RESET}\n")


def format_response(text):
    """Format response with markdown-like styling"""
    # Bold text
    text = re.sub(r'\*\*(.*?)\*\*', f'{Colors.BOLD}\\1{Colors.RESET}', text)
    # Italic text
    text = re.sub(r'\*(.*?)\*', f'{Colors.UNDERLINE}\\1{Colors.RESET}', text)
    # Code blocks
    text = re.sub(r'```(\w*)\n(.*?)```', f'\n{Colors.BG_BLACK}{Colors.GREEN}\\2{Colors.RESET}\n', text, flags=re.DOTALL)
    # Inline code
    text = re.sub(r'`(.*?)`', f'{Colors.BG_BLACK}{Colors.GREEN}\\1{Colors.RESET}', text)
    # Headers
    text = re.sub(r'^### (.*?)$', f'\n{Colors.BOLD}{Colors.BRIGHT_BLUE}\\1{Colors.RESET}\n', text, flags=re.MULTILINE)
    text = re.sub(r'^## (.*?)$', f'\n{Colors.BOLD}{Colors.BRIGHT_MAGENTA}\\1{Colors.RESET}\n', text, flags=re.MULTILINE)
    text = re.sub(r'^# (.*?)$', f'\n{Colors.BOLD}{Colors.CYAN}â• {Colors.RESET}{Colors.BOLD}{Colors.CYAN}\\1{Colors.RESET}\n', text, flags=re.MULTILINE)
    # Lists
    text = re.sub(r'^- (.*?)$', f'{Colors.YELLOW}â€¢{Colors.RESET} \\1', text, flags=re.MULTILINE)
    text = re.sub(r'^(\d+)\. (.*?)$', f'{Colors.YELLOW}\\1.{Colors.RESET} \\2', text, flags=re.MULTILINE)
    # Links
    text = re.sub(r'\[([^\]]+)\]\(([^)]+)\)', f'{Colors.UNDERLINE}{Colors.BLUE}\\1{Colors.RESET}', text)

    return text


def print_user(text):
    """Print user message with styling"""
    print(f"\n{Colors.BOLD}{Colors.BRIGHT_GREEN}â”Œâ”€ You â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")
    print(f"{Colors.BOLD}{Colors.BRIGHT_GREEN}â”‚{Colors.RESET} {text}")
    print(f"{Colors.BOLD}{Colors.BRIGHT_GREEN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")


def print_assistant(text, streamed=False):
    """Print assistant message with styling"""
    formatted = format_response(text) if not streamed else text

    print(f"\n{Colors.BOLD}{Colors.BRIGHT_BLUE}â”Œâ”€ Perplexity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")
    print(f"{Colors.BOLD}{Colors.BRIGHT_BLUE}â”‚{Colors.RESET}")

    for line in formatted.split('\n'):
        print(f"{Colors.BOLD}{Colors.BRIGHT_BLUE}â”‚{Colors.RESET} {line}")

    print(f"{Colors.BOLD}{Colors.BRIGHT_BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")


def print_citations(citations):
    """Print citations with styling"""
    if citations:
        print(f"\n{Colors.BOLD}{Colors.YELLOW}ðŸ“š Sources{Colors.RESET}")
        for i, citation in enumerate(citations, 1):
            print(f"  {Colors.DIM}[{i}] {citation[:80]}{'...' if len(citation) > 80 else ''}{Colors.RESET}")


def print_streaming_indicator():
    """Print streaming indicator"""
    return f"{Colors.DIM}â³ {Colors.RESET}"


class ChatSession:
    """Manage chat session with conversation history"""

    def __init__(self, model="sonar-pro", system_prompt=None):
        self.model = model
        self.system_prompt = system_prompt or "You are a helpful assistant."
        self.messages = [{"role": "system", "content": self.system_prompt}]
        self.history_dir = Path.home() / ".cache" / "perplexity"
        self.history_dir.mkdir(parents=True, exist_ok=True)
        self.created_at = datetime.now()

    def add_message(self, role, content):
        self.messages.append({"role": role, "content": content})

    def get_messages(self):
        return self.messages

    def save_session(self, name=None):
        if not name:
            name = f"chat_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        filepath = self.history_dir / name

        with open(filepath, 'w') as f:
            json.dump({
                "timestamp": datetime.now().isoformat(),
                "created_at": self.created_at.isoformat(),
                "model": self.model,
                "messages": self.messages
            }, f, indent=2)

        return filepath

    def list_sessions(self):
        sessions = []
        for file in sorted(self.history_dir.glob("chat_*.json")):
            try:
                with open(file) as f:
                    data = json.load(f)
                    sessions.append({
                        "file": file,
                        "timestamp": data.get("timestamp", ""),
                        "message_count": len(data.get("messages", [])) - 1
                    })
            except:
                pass
        return sessions

    def load_session(self, filepath):
        with open(filepath) as f:
            data = json.load(f)
        self.messages = data.get("messages", [])
        self.model = data.get("model", self.model)
        return len(self.messages) - 1

    def export_markdown(self, output_file):
        """Export conversation to markdown file"""
        with open(output_file, 'w') as f:
            f.write(f"# Perplexity Chat Export\n\n")
            f.write(f"**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"**Model:** {self.model}\n\n")
            f.write("---\n\n")

            for msg in self.messages:
                if msg["role"] == "system":
                    continue
                elif msg["role"] == "user":
                    f.write(f"## You\n\n{msg['content']}\n\n")
                elif msg["role"] == "assistant":
                    f.write(f"## Perplexity\n\n{msg['content']}\n\n")


def query_perplexity(client, prompt, session, stream=False):
    """Send query to Perplexity API"""
    session.add_message("user", prompt)

    if stream:
        full_response = ""

        print(f"\n{Colors.BOLD}{Colors.BRIGHT_BLUE}â”Œâ”€ Perplexity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")
        print(f"{Colors.BOLD}{Colors.BRIGHT_BLUE}â”‚{Colors.RESET} ", end="", flush=True)

        response = client.chat.completions.create(
            model=session.model,
            messages=session.get_messages(),
            stream=True
        )

        col = 0
        for chunk in response:
            if chunk.choices and chunk.choices[0].delta.content:
                content = chunk.choices[0].delta.content
                full_response += content

                # Simple word wrapping for streaming
                for char in content:
                    print(char, end="", flush=True)
                    col += 1
                    if col >= 68:
                        print(f"\n{Colors.BOLD}{Colors.BRIGHT_BLUE}â”‚{Colors.RESET} ", end="", flush=True)
                        col = 0

        print(f"{Colors.BOLD}{Colors.BRIGHT_BLUE}\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{Colors.RESET}")
        session.add_message("assistant", full_response)
        return full_response, None
    else:
        response = client.chat.completions.create(
            model=session.model,
            messages=session.get_messages()
        )

        answer = response.choices[0].message.content
        citations = []

        if hasattr(response.choices[0].message, "citations") and response.choices[0].message.citations:
            citations = response.choices[0].message.citations

        session.add_message("assistant", answer)
        return answer, citations


def interactive_chat(client, session, args):
    """Interactive chat mode (REPL)"""
    print_welcome(args.model)
    conversation_count = 0

    while True:
        try:
            # Get user input
            user_input = input(f"{Colors.BOLD}{Colors.GREEN}You:{Colors.RESET} ").strip()

            # Handle slash commands
            if user_input.startswith('/'):
                cmd = user_input.lower()

                if cmd in ('/quit', '/exit', '/q'):
                    if conversation_count > 0:
                        save = input(f"\n{Colors.YELLOW}Save this conversation? (y/n): {Colors.RESET}")
                        if save.lower() == 'y':
                            filepath = session.save_session()
                            print(f"{Colors.GREEN}âœ“ Saved to: {filepath}{Colors.RESET}")
                    print(f"\n{Colors.BOLD}Goodbye! ðŸ‘‹{Colors.RESET}\n")
                    break

                elif cmd == '/clear':
                    session.messages = [{"role": "system", "content": session.system_prompt}]
                    conversation_count = 0
                    print(f"{Colors.YELLOW}âœ“ Conversation cleared.{Colors.RESET}\n")
                    continue

                elif cmd == '/save':
                    filepath = session.save_session()
                    print(f"{Colors.GREEN}âœ“ Saved to: {filepath}{Colors.RESET}\n")
                    continue

                elif cmd == '/export':
                    output_file = input(f"{Colors.YELLOW}Output filename (e.g. chat.md): {Colors.RESET}")
                    if not output_file.endswith('.md'):
                        output_file += '.md'
                    output_path = Path(output_file).expanduser()
                    session.export_markdown(output_path)
                    print(f"{Colors.GREEN}âœ“ Exported to: {output_path}{Colors.RESET}\n")
                    continue

                elif cmd == '/history':
                    sessions = session.list_sessions()
                    if sessions:
                        print(f"\n{Colors.BOLD}ðŸ“‚ Saved Conversations{Colors.RESET}")
                        for s in sessions:
                            print(f"  â€¢ {Colors.CYAN}{s['file'].name}{Colors.RESET} ({s['message_count']} msgs) - {s['timestamp']}")
                    else:
                        print(f"{Colors.DIM}No saved conversations.{Colors.RESET}")
                    print()
                    continue

                elif cmd == '/load':
                    sessions = session.list_sessions()
                    if sessions:
                        print(f"\n{Colors.BOLD}ðŸ“‚ Saved Conversations{Colors.RESET}")
                        for i, s in enumerate(sessions, 1):
                            print(f"  [{i}] {Colors.CYAN}{s['file'].name}{Colors.RESET} ({s['message_count']} msgs)")
                        choice = input(f"\n{Colors.YELLOW}Load which one? (number or 'cancel'): {Colors.RESET}")
                        if choice.lower() != 'cancel':
                            try:
                                idx = int(choice) - 1
                                if 0 <= idx < len(sessions):
                                    count = session.load_session(sessions[idx]['file'])
                                    print(f"{Colors.GREEN}âœ“ Loaded {count} messages.{Colors.RESET}\n")
                                    continue
                            except ValueError:
                                pass
                    else:
                        print(f"{Colors.DIM}No saved conversations.{Colors.RESET}\n")
                    continue

                elif cmd == '/status':
                    print_status(client, session)
                    continue

                elif cmd == '/help':
                    print_help()
                    continue

                elif cmd in ('/?', '--help'):
                    print_help()
                    continue

                else:
                    print(f"{Colors.RED}Unknown command: {user_input}{Colors.RESET}")
                    print(f"{Colors.DIM}Type '/help' for available commands.{Colors.RESET}\n")
                    continue

            elif not user_input:
                continue

            # Process the query
            try:
                answer, citations = query_perplexity(
                    client, user_input, session, stream=args.stream
                )

                if not args.stream:
                    print_assistant(answer)
                    if citations:
                        print_citations(citations)

                print()  # spacing
                conversation_count += 1

            except KeyboardInterrupt:
                print(f"\n\n{Colors.YELLOW}âš  Interrupted. Type '/quit' to exit.{Colors.RESET}\n")
            except Exception as e:
                print(f"\n{Colors.RED}âœ— Error: {e}{Colors.RESET}\n")

        except KeyboardInterrupt:
            print(f"\n\n{Colors.YELLOW}âš  Use '/quit' to exit.{Colors.RESET}\n")
        except EOFError:
            print(f"\n\n{Colors.BOLD}Goodbye! ðŸ‘‹{Colors.RESET}\n")
            break


def main():
    parser = argparse.ArgumentParser(
        description="Query Perplexity API from the terminal",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=f"""{Colors.BOLD}Examples:{Colors.RESET}
  {Colors.GREEN}perplexity{Colors.RESET} "What is the capital of France?"
  {Colors.GREEN}perplexity{Colors.RESET} "Latest AI developments" --search
  {Colors.GREEN}perplexity{Colors.RESET} --chat
  {Colors.GREEN}perplexity{Colors.RESET} --chat --stream
  {Colors.GREEN}perplexity{Colors.RESET} "Explain quantum computing" --system "You are a physics teacher"
"""
    )
    parser.add_argument(
        "query",
        nargs="?",
        help="Your question or search query (use --chat for interactive mode)"
    )
    parser.add_argument(
        "--model",
        default="sonar-pro",
        choices=["sonar-pro", "sonar-medium-online", "sonar-small-online"],
        help="Model to use (default: sonar-pro)"
    )
    parser.add_argument(
        "--api-key",
        default=DEFAULT_API_KEY,
        help="Perplexity API key (default: uses PERPLEXITY_API_KEY env var)"
    )
    parser.add_argument(
        "--search",
        action="store_true",
        help="Use research-focused mode"
    )
    parser.add_argument(
        "--stream",
        action="store_true",
        help="Stream the response as it comes in"
    )
    parser.add_argument(
        "--chat",
        "-c",
        action="store_true",
        help="Enter interactive chat mode"
    )
    parser.add_argument(
        "--system",
        "-s",
        help="Custom system prompt"
    )
    parser.add_argument(
        "--no-color",
        action="store_true",
        help="Disable colored output"
    )

    args = parser.parse_args()

    # Disable colors if requested or not a TTY
    if args.no_color or not sys.stdout.isatty():
        for attr in dir(Colors):
            if attr.isupper():
                setattr(Colors, attr, "")

    try:
        from openai import OpenAI
    except ImportError:
        print(f"{Colors.RED}Error: OpenAI library not installed.{Colors.RESET}")
        print("Install it with: pip install openai")
        sys.exit(1)

    try:
        client = OpenAI(api_key=args.api_key, base_url="https://api.perplexity.ai")

        # Determine system prompt
        if args.system:
            system_prompt = args.system
        elif args.search:
            system_prompt = "You are a research assistant. Provide detailed, well-sourced answers with citations."
        else:
            system_prompt = "You are a helpful assistant."

        # Create session
        session = ChatSession(model=args.model, system_prompt=system_prompt)

        # Interactive chat mode
        if args.chat or not args.query:
            interactive_chat(client, session, args)
        else:
            # Single query mode
            print_header("Perplexity")

            try:
                answer, citations = query_perplexity(
                    client, args.query, session, stream=args.stream
                )

                if not args.stream:
                    print_assistant(answer)
                    if citations:
                        print_citations(citations)
                print()

            except KeyboardInterrupt:
                print(f"\n\n{Colors.YELLOW}Interrupted.{Colors.RESET}\n")
            except Exception as e:
                print(f"{Colors.RED}Error: {e}{Colors.RESET}\n", file=sys.stderr)
                sys.exit(1)

    except Exception as e:
        print(f"{Colors.RED}Error: {e}{Colors.RESET}\n", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
